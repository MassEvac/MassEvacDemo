<!DOCTYPE html>
<html>
<head>
    <title>Mass Evacuation Demo</title>
    <meta charset="utf-8" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

   <style>
   html, body, #map {
      height:100%;
      width:100%;
      padding:0px;
      margin:0px;
   }          
   .info {
        padding: 10px 16px;
        font: 12px/14px Arial, Helvetica, sans-serif;
        background: white;
        background: rgba(255,255,255,0.9);
        box-shadow: 0 0 15px rgba(0,0,0,0.2);
        border-radius: 5px;
        text-align: left;
        max-width: 307px;            
    }
    .info h3 {
        margin: 10px 0 5px;
        color: #777;
        text-align: center;
    }     
    .info p {
        margin: 0px 0 5px;
        color: #777;
        text-align: center;
    }        
   </style>

    <link rel="stylesheet" href="leaflet-0.7.3/leaflet.css" />
    
    <script type="text/javascript" src="html5lightbox/jquery.js"></script>
    <script type="text/javascript" src="html5lightbox/html5lightbox.js"></script>

    <script type="text/javascript">
        var html5lightbox_options = {
            watermark: "http://cdn.ientry.com/sites/webpronews/pictures/new-google-logo.jpg",
            watermarklink: "http://html5box.com"
        };
    </script>     
    
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-56012994-1', 'auto');
      ga('send', 'pageview');

    </script>
    
</head>
<body>
    <div id="map"></div>
    <script type="text/javascript" src="./leaflet-0.7.3/leaflet.js"></script>  
    <script type="text/javascript">
        var markers = [];

        var mbAttr = 'Simulations &copy; <a href="http://www.bristol.ac.uk/engineering/people/bharat-b-kunwar/index.html">Bharat Kunwar</a>, ' + 
                'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
                '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                'Imagery &copy; <a href="http://mapbox.com">Mapbox</a>';
            
        var mbUrl = 'http://{s}.tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png'

        var streets  = L.tileLayer(mbUrl, {id: 'mapbox.streets',   attribution: mbAttr}),
            grayscale   = L.tileLayer(mbUrl, {id: 'mapbox.light', attribution: mbAttr});

        var cities = L.layerGroup();      

        var map = L.map('map', {
            layers: [cities,grayscale]
        });
        
        function score(D90,T90){
            T90f = D90/1.34/60
            return Math.round(T90f/T90*10) 
        }

        function onEachFeature(feature, layer) {
            keys = ['D10%','T10%','D50%','T50%','D90%','T90%']
            s = score(feature.properties['D90%'],feature.properties['T90%'])

            if (feature.geometry.type == 'Polygon'){
                var popupContent = "<h2>" + feature.properties['name'] + ": Overview</h2>";
            } else {
                var popupContent = "<h2>" + feature.properties['name'] + ": Exit Detail</h2>";
            }

            popupContent += s + "/10 evacuation score (higher is better)<br/>";

            popupContent += feature.properties['pop'] + " assumed evacuees.</br>";
            
            if (feature.geometry.type == 'Polygon'){
                popupContent += feature.properties['no_of_destins'] + " identifiable exits.<br/>";
                // popupContent += "<a href='"+feature.properties['video']+"' class='html5lightbox' data-group='"+feature.properties['name']+"' title='Evacuation Simulation Video ("+feature.properties['name']+")'>Video</a><br/>";
                popupContent += "<video width='320' height='240' controls><source src='"+feature.properties['video']+"' type='video/mp4'>Your browser does not support the video tag.</video>"
            }
            
            popupContent += "<p><table><tr><th>% of population</th><th>Distance to nearest exit</th><th>Minimum time required to evacuate</th></tr><tr><td>10%</td><td>"+Math.round(feature.properties[keys[0]])+" metres</td><td>"+Math.round(feature.properties[keys[1]])+" minutes</td></tr><tr><td>50%</td><td>"+Math.round(feature.properties[keys[2]])+" metres</td><td>"+Math.round(feature.properties[keys[3]])+" minutes</td></tr><tr><td>90%</td><td>"+Math.round(feature.properties[keys[4]])+" metres</td><td>"+Math.round(feature.properties[keys[5]])+" minutes</td></tr></table></p>";

            if (feature.geometry.type == 'Polygon'){
                layer.bindPopup(popupContent)
                .on({
                    click: zoomToFeature
                });
            } else {
                layer.bindPopup(popupContent);                
            }
        }

        function zoomToFeature(e) {
            console.log(e)
            map.setView(e.latlng,10)
            .panBy([0,-250]);    
            // map.fitBounds(e.target.getBounds(),{padding:[50,50]});                  
        }

        var colourscore = ['#ff6347', '#f57a44', '#ea8d41', '#de9e3e', '#d1af3a', '#c1bd36', '#b0cc31', '#9cd82a', '#82e622', '#5ff217', '#00ff00']

        var overview;

        // GeoJSON overview layer with polygon boundaries
        $.getJSON('./overview.json', function(data) {
            
            console.log(data)

            overview = L.geoJson(data, {

                style: function (feature) {
                    s = score(feature.properties['D90%'],feature.properties['T90%'])
                    console.log(s)                    
                    return feature.properties && {
                        weight: 0,
                        color: "#FFF",
                        opacity: 1,
                        fillColor: colourscore[s],
                        fillOpacity: 0.5
                    };
                },

                onEachFeature: onEachFeature

            }).addTo(map)
            .on('click', onClick);;

            map.fitBounds(overview.getBounds());
        });

        function onClick(e) {
            $(".html5lightbox").html5lightbox();            
        }        

        var detail;

        // GeoJSON detail layer with polygon boundaries
        $.getJSON('./detail.json', function(data) {
            
            console.log(data)

            detail = L.geoJson(data, {

                pointToLayer: function (feature, latlng) {
                    s = score(feature.properties['D90%'],feature.properties['T90%'])
                    console.log(s)
                    return L.circleMarker(latlng, {
                        radius: 10,
                        fillColor: colourscore[s],
                        color: "#FFF",
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.5
                    });
                },

                onEachFeature: onEachFeature

            });
        });

        // control that shows state info on hover
        var info = L.control();

        info.onAdd = function () {
            this._div = L.DomUtil.create('div', 'info');
            this._div.innerHTML = "<h3>Mass Evacuation Demo . <a href='http://massevac.github.io/' target='_blank'>Blog</a> . <a href='mailto:b.kunwar@bristol.ac.uk'>Email</a> . <a href='http://twitter.com/massevac'>Twitter</a></h3>";
            return this._div;
        };
        
        info.addTo(map);

        var help = L.control();            
        help.onAdd = function () {
            this._div = L.DomUtil.create('div', 'info');
            this.help = false;                
            this.update();
            return this._div;
        };
        help.update = function () {
            if (this.helpToggle == true) {
                this._div.innerHTML = "<p><a href='#' onclick='myhelp()'>Close</a></p>"+

                "<h3>Zoom and click on a city to begin.</h3>"+  
                "Imagine you are told that there has been a nuclear meltdown nearby and that need to evacuate now. Since everyone else will also be trying to do the same, major road links may be strained beyond maximum operating capacity depending on how populated your neighbourhood is and number of exits. We have all experienced slowing down in a such dense crowd at some point in our lives. This behaviour is neatly described by this <a href='fd-figure.png' class='html5lightbox' title='Pedestrian Fundamental Diagram: The best flow here is around 3 agents per meter per second.'>fundamental diagram</a> which is an approximation of walking behaviour from observation of real people. As we managed to demonstrate using our bespoke <a href='photos/BBK_9132.png' data-group='FON' class='html5lightbox' title='Sarah and Nick demonstrating our 'lentil-o-meter' at Festival of Nature 2014!'>'lentil-o-meter'</a><a href='photos/BBK_9121.png' data-group='FON' class='html5lightbox' title='Neil and Bharat demonstrating our 'lentil-o-meter' at Festival of Nature 2014!'></a>, bottlenecks do cause delay to the rate at which lentils are able to flow through an aperture! Wouldn't it be nice to know in advance what routes are more likely to be available is such emergencies? As such, this website showcases total evacuation for some UK cities which Bharat is investigating as a part of his PhD. Feedback, feature and location requests are welcome. All information provided is intended to be consumed with a pinch of salt.<br/>"+                    

                "<h3> Assumptions:</h3><ol>"+
                "<li> Evacuation type is a total evacuation scenario, for which exit nodes lie at intersection between major roads and city administrative boundary. <br/>"+
                "<li> Evacuation mode is by walking only. <br/>"+
                "<li> No dynamic routing due to avoid congestion at bottlenecks.</ol><br/>"+

                "<p>Website last updated: 6 January 2016</p>";
                $(".html5lightbox").html5lightbox();
            } else this._div.innerHTML = "<p><a href='#' onclick='myhelp()'>Help!</a></p>";
        };
        window.myhelp = function (){
            help.helpToggle = !help.helpToggle;    
            help.update()
            map.fitBounds(group.getBounds());                
        }
        help.addTo(map);
        
        var popup = L.popup();
        
        function onMapClick(e) {
            popup
                .setLatLng(e.latlng)
                .setContent(e.latlng.toString())
                .openOn(map);
        }
        
        map
            // Show latlng on right click
            .on('contextmenu', onMapClick)
            // When the zoom level is changes,
            // decide whether to show different part of the map
            .on('zoomend', function (e) {
                var currentZoom = map.getZoom();
                console.log(currentZoom)
                if (currentZoom < 10){
                    map.removeLayer(detail)
                } else {
                    map.addLayer(detail)
                }
            });
    </script>
</body>
</html>
